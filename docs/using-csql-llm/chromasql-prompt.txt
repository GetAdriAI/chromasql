## Core Facts
- Read-only DSL: ChromaSQL issues `SELECT`/`EXPLAIN` queries; it never mutates data.
- Single collection per query: There are no joins. To span models/collections, filter on the discriminator metadata key and run one ChromaSQL statement at a time.
- Every collection stores `id`, `document`, `embedding`, `metadata`, and query-time `distance`. Project only what the request needs; embeddings must be explicitly selected.
- Use dotted paths for metadata: `metadata.model_name`, `metadata.category`, etc. Alias with `AS` when helpful.
- Clause order:
  `SELECT … FROM … [USING EMBEDDING …] [WHERE …] [WHERE_DOCUMENT …] [SIMILARITY …] [WITH SCORE THRESHOLD …] [RERANK …] [ORDER BY …] [LIMIT … [OFFSET …]];`  
  `EXPLAIN` precedes the `SELECT`.

## Filtering
- `WHERE` targets metadata. Supported operators: `=`, `!=`, `<`, `<=`, `>`, `>=`, `IN`, `NOT IN`, `BETWEEN`, `%LIKE%`, `CONTAINS`.
- `WHERE_DOCUMENT` filters the natural-language `document`. Only `CONTAINS` and `%LIKE%` are valid there.
- Combine predicates with `AND` / `OR` (wrap complex logic in parentheses). Respect operator precedence.

## Vector Search
- Add `USING EMBEDDING (…)` for similarity search. Options:
  - `TEXT '…'` (embedding generated by the executor; ensure an embedder is available).
  - `VECTOR [f32, …]` when you already have a vector.
  - `BATCH (…)` for multiple items (each entry may be `TEXT` or `VECTOR`).
- Always add `TOPK n` with embedding queries; the default is 10.
- Change the metric with `SIMILARITY COSINE | L2 | IP`. Omit to keep the collection default.
- Optional `WITH SCORE THRESHOLD x` discards rows whose distance exceeds `x`.
- `RERANK BY MMR(lambda = …, candidates = …)` is a hint your orchestration layer should honour post-query.

## Sorting & Pagination
- `ORDER BY` supports `distance`, `id`, or metadata paths. Vector queries sort by `distance ASC` by default.
- Use `LIMIT n` and optional `OFFSET m` to paginate after retrieval. These operate on the merged result set.

## Filter-Only Retrieval
- Omitting `USING EMBEDDING` yields a metadata-only lookup (`collection.get`). `distance` cannot be selected or ordered in this mode.

## Diagnostics
- `EXPLAIN` before `SELECT` returns the planned request without hitting ChromaDB. 

## Limitations & Pitfalls
- No DML, DDL, joins, aggregations, window functions, or arithmetic expressions in `ORDER BY`.
- `LIKE` only supports `%pattern%` (no `_` wildcard or middle `%` placement).
- `CONTAINS` checks membership for arrays or substring for strings; ensure the underlying metadata type matches the operator semantics.
- Batch queries apply `TOPK` per batch item; deduplicate downstream if necessary.
- Rerank clauses annotate plans only. You must call the reranker using the hint parameters.